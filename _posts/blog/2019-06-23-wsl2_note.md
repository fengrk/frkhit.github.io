---
layout: post
title: wsl2 ä½¿ç”¨ä½“éªŒ
category: æŠ€æœ¯
tags: wsl2, linux
keywords: 
description: 
---

# wsl2 ä½¿ç”¨ä½“éªŒ

## ä¼˜ç‚¹1. docker æ­£å¸¸å·¥ä½œ

wsl2å…¶å®žæ˜¯ä¸€ä¸ªå®Œæ•´çš„è™šæ‹Ÿæœº, docker åœ¨é‡Œé¢å·¥ä½œæ­£å¸¸ã€‚


## å‘1. wsl ip ä¸å›ºå®š

wsl é‡å¯åŽï¼Œ ip å˜åŠ¨ã€‚

è¿™ä¸ªå‘ä¹Ÿæœ‰äººé‡åˆ°ï¼š[[WSL 2] NIC Bridge mode ðŸ–§ (Has WorkaroundðŸ”¨)](https://github.com/microsoft/WSL/issues/4150).

ç ”ç©¶å¾®è½¯çš„è¯´æ˜Žï¼Œæ‰å‘çŽ°è¿™ä¸ªæ˜¯feature: [User Experience Changes Between WSL 1 and WSL 2](https://docs.microsoft.com/en-us/windows/wsl/wsl2-ux-changes).

è§£å†³æ€è·¯ï¼Œwin10é€šè¿‡åŸŸå`wsl.wsl`è®¿é—®wslï¼› wslå†…éƒ¨è´Ÿè´£å°†ipå†™å…¥win10çš„hostsæ–‡ä»¶ä¸­ã€‚ä½¿ç”¨pythonå®žçŽ°è¿™ä¸ªé€»è¾‘:

```
import subprocess

import re


def get_address_info():
    s1 = subprocess.Popen(["ifconfig"], stdout=subprocess.PIPE)
    out_string = s1.stdout.read().decode("utf-8")

    # address name
    address_name_list = []
    for line in out_string.split("\n"):
        if line and line.find("flags=") > -1:
            address_name_list.append(line.split(":")[0])

    # ip
    re_address = re.compile(r'(?<=inet )[\d\.]{3,20}?(?=  netmask)')
    all_address = re_address.findall(out_string)

    #
    assert len(address_name_list) == len(all_address)
    return {address_name_list[i]: ip for i, ip in enumerate(all_address)}


def get_wsl_ip() -> str:
    add_info = get_address_info()
    return add_info["eth0"]


def update_wsl_ip(new_ip: str):
    """ update ip """
    host_file = "/mnt/c/Windows/System32/drivers/etc/hosts"
    with open(host_file, "r") as f:
        lines = f.readlines()

    change = False
    found = False
    for i, line in enumerate(lines):
        if len(line) > 5 and line.find("wsl.wsl") > -1:
            found = True
            if line.find(new_ip) > -1:
                print("not change: ip is same!")
            else:
                lines[i] = "{}\twsl.wsl\n".format(new_ip)
                print("change: ip is different!")
                change = True
            break

    if not found:
        lines.append("{}\twsl.wsl\n".format(new_ip))
        print("change: ip not exists!")
        change = True

    if lines and change:
        with open(host_file, "w") as f:
            f.write("".join(lines))


if __name__ == '__main__':
    update_wsl_ip(new_ip=get_wsl_ip())
```

wsl2 ä¸­ è®¾ç½®å®šæ—¶ä»»åŠ¡:

```
*/15 * * * * cat ~/.ssh/sss.dat | sudo -S python3 ~/refresh_hosts.py
```
