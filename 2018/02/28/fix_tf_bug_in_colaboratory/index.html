<!doctype html>
<head>
    <meta charset="utf-8">
    <title>修复colaboratory中tensorflow的bug</title>
    <link rel="stylesheet" href="/static/css/style.css">
    

</head>
<body class="box">

<nav class="nav-menu">
    <ul>
        <li><a href="/">首页</a></li>
        <li><a href="https://github.com/frkhit/frkhit.github.io">源码</a></li>
    </ul>
</nav>

<div class="container">

    <div class="content" role="main">
        
    <h1>
<a id="user-content-修复colaboratory中tensorflow的bug" class="anchor" href="#%E4%BF%AE%E5%A4%8Dcolaboratory%E4%B8%ADtensorflow%E7%9A%84bug" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>修复colaboratory中tensorflow的bug</h1>
<p>colaboratory是google推出的类似jupyter的一款产品. 免费使用，提供一个gpu，cpu内存约为12GB. 配合google drive, 可方便进行机器学习的练习.</p>
<p>colaboratory中的python环境自带丰富的包, tensorflow, pandas, numpy等一应俱全. 但在使用的过程中,发现自带的tensorflow,存在一个bug. 通过探索,本文提供一种修复方案.</p>
<h2>
<a id="user-content-1bug描述" class="anchor" href="#1bug%E6%8F%8F%E8%BF%B0" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1.bug描述</h2>
<p>colaboratory环境:</p>
<pre><code>import sys
import tensorflow as tf

print(tf.__version__) #  1.6.0-rc1

print(sys.version) # 3.6.3 (default, Oct  3 2017, 21:45:48) \n[GCC 7.2.0]

</code></pre>
<p>在colab中使用slim时, 使用以下代码:</p>
<pre><code>slim.assign_from_checkpoint_fn(
        pretrained_model_file,
        variables_to_restore,
        ignore_missing_vars=True)

</code></pre>
<p>当 <code>pretrained_model_file = "/content/vgg_19.ckpt" # vgg_19.ckpt为pre-trained model的ckpt文件</code>, 报异常:</p>
<pre><code>---------------------------------------------------------------------------
ValueError                                Traceback (most recent call last)
&lt;ipython-input-29-b803c1b9c409&gt; in &lt;module&gt;()
     10 
     11 
---&gt; 12 demo()

&lt;ipython-input-29-b803c1b9c409&gt; in demo()
      7             "1000", "--network", "/content/vgg_19.ckpt",
      8             "--checkpoint-iterations", "10", "--checkpoint-output", "/content/tmp-tv-%s.jpg"]
----&gt; 9     neural_style_main(args)
     10 
     11 

/usr/local/lib/python3.6/dist-packages/neural_style_demo/neural_style.py in main(args)
    178         pooling=options.pooling,
    179         print_iterations=options.print_iterations,
--&gt; 180         checkpoint_iterations=options.checkpoint_iterations
    181     ):
    182         output_file = None

/usr/local/lib/python3.6/dist-packages/neural_style_demo/stylize.py in stylize(network, initial, initial_noiseblend, content, styles, preserve_colors, iterations, content_weight, content_weight_blend, style_weight, style_layer_weight_exp, style_blend_weights, tv_weight, learning_rate, beta1, beta2, epsilon, pooling, print_iterations, checkpoint_iterations)
     77                                                     naming="style-{}".format(i),
     78                                                     pretrained_model_file=pretrained_model_file,
---&gt; 79                                                     checkpoint_exclude_scopes=checkpoint_exclude_scopes)
     80 
     81         for index, layer in enumerate(STYLE_LAYERS):

/usr/local/lib/python3.6/dist-packages/neural_style_demo/losses.py in get_style_features(model_name, style_image, image_size, style_layers, naming, pretrained_model_file, checkpoint_exclude_scopes)
     97                 break
     98         if not excluded:
---&gt; 99             variables_to_restore.append(var)
    100 
    101     return assign_from_checkpoint_fn(

/usr/local/lib/python3.6/dist-packages/tensorflow/contrib/framework/python/ops/variables.py in callback(session)
    688     saver = tf_saver.Saver(var_list, reshape=reshape_variables)
    689     def callback(session):
--&gt; 690       saver.restore(session, model_path)
    691     return callback
    692   else:

/usr/local/lib/python3.6/dist-packages/tensorflow/python/training/saver.py in restore(self, sess, save_path)
   1754       raise ValueError("The specified path: %s is a file."
   1755                        " Please specify only the path prefix"
-&gt; 1756                        " to the checkpoint files." % save_path)
   1757     logging.info("Restoring parameters from %s", save_path)
   1758     if context.in_graph_mode():

ValueError: The specified path: /content/vgg_19.ckpt is a file. Please specify only the path prefix to the checkpoint files.


</code></pre>
<p><em>该代码在本地环境中运行正常!</em></p>
<h2>
<a id="user-content-2bug的引发原因" class="anchor" href="#2bug%E7%9A%84%E5%BC%95%E5%8F%91%E5%8E%9F%E5%9B%A0" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.bug的引发原因</h2>
<p>google检索,发现该问题有人遇到过,但没有提供原因分析及解决方案.</p>
<p>经过一通排查,将注意力放在</p>
<pre><code>/usr/local/lib/python3.6/dist-packages/tensorflow/python/training/saver.py in restore(self, sess, save_path)
   1754       raise ValueError("The specified path: %s is a file."
   1755                        " Please specify only the path prefix"
-&gt; 1756                        " to the checkpoint files." % save_path)
   1757     logging.info("Restoring parameters from %s", save_path)
   1758     if context.in_graph_mode():

</code></pre>
<p>代码段中.</p>
<p>下载<a href="https://github.com/tensorflow/tensorflow">tensorflow源码</a>, 发现master, r1.6分支中的代码均没发现 <code>Please specify only the path prefix</code> 字符串.</p>
<p>找到对应的<a href="https://raw.githubusercontent.com/tensorflow/tensorflow/r1.6/tensorflow/python/training/saver.py" rel="nofollow">saver.py</a>文件,也没发现上述字符串.</p>
<p>查看save.py文件的git更新历史</p>
<pre><code>git log --pretty=oneline tensorflow/python/training/saver.py

</code></pre>
<pre><code>43ecf848478940904e1a2df10df6bfe72163a38d Revert "Add checkpoint file prefix check (#14341)"
3bd65900f67af950797ef89dde0d984e8b2d0d7a Merge commit for internal changes
e9d4d3d06c0fb211f7488f868fefb477f07df4f8 Adding tf_export decorators/calls to TensorFlow functions and constants.
fa1949b2a73759798e24c640ecd2036d623f6858 Merge commit for internal changes
d56883617c07125eb9d488bc73baccaacd55f48b Enable bulk restoration by default.
2a16133061ba3f8fa60c0338cd629f2211f9b17d Add checkpoint file prefix check (#14341)

</code></pre>
<p>发现该问题是代码更新引起的, 研究代码及<a href="https://github.com/tensorflow/tensorflow/pull/14341">#14341</a>, 得出bug引发的原因:</p>
<ul>
<li>引入新特性, 针对特定的模型,不允许模型恢复的save_path参数为文件名</li>
<li>收集反馈后,该特性撤销</li>
<li>colaboratory中的tensorflow,使用了带新特性的编译包</li>
</ul>
<h2>
<a id="user-content-3bug修复方案" class="anchor" href="#3bug%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%A1%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3.bug修复方案</h2>
<p>重装tensorflow包,难以针对colab环境编译,存在风险.</p>
<p>暂时发现最优的方案是: 直接替换环境中saver.py文件.</p>
<p>colab中执行如下(建议在笔记新建后,首先执行该操作):</p>
<p>1.更新saver.py文件</p>
<pre><code># 更新saver.py文件
!wget -O /usr/local/lib/python3.6/dist-packages/tensorflow/python/training/saver.py 'https://raw.githubusercontent.com/tensorflow/tensorflow/r1.6/tensorflow/python/training/saver.py'

# 添加追踪标志
# 原来的环境中,numpy的版本为1.14.0
# 更新后, numpy版本为1.14.1
!pip install --upgrade numpy
import numpy as np
np.__version__ # 1.14.0

</code></pre>
<p>2.重启环境</p>
<p>Ctrl + M 重启环境</p>
<p>3.检查是否生效</p>
<pre><code>
import numpy as np
np.__version__ # 1.14.1

</code></pre>
<p>当numpy的版本信息更新后, 便能确认环境重启成功.</p>
<p>再执行slim代码便能正常工作.</p>


    </div>

</div><!-- end container -->
<script src="/static/js/script.js"></script>
</body>
</html>