<!doctype html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="utf-8">
    <title>定时备份linux系统的history记录</title>
    <link rel="stylesheet" href="/static/css/github.css">
    <link rel="stylesheet" href="/static/css/style.css">
    

</head>
<body class="box">

<nav class="nav-menu">
    <ul>
        <li><a href="/">首页</a></li>
        <li><a href="https://github.com/frkhit/frkhit.github.io">源码</a></li>
    </ul>
</nav>

<div class="container">

    <div class="content" role="main">
        
    <h1>
<a id="user-content-定时备份linux系统的history记录" class="anchor" href="#%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BDlinux%E7%B3%BB%E7%BB%9F%E7%9A%84history%E8%AE%B0%E5%BD%95" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>定时备份linux系统的history记录</h1>
<h1>
<a id="user-content-1-下新建backup_historypy文件" class="anchor" href="#1-%E4%B8%8B%E6%96%B0%E5%BB%BAbackup_historypy%E6%96%87%E4%BB%B6" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. <code>~</code>下新建<code>backup_history.py</code>文件</h1>
<p>代码为</p>
<pre><code># -*- coding:utf-8 -*-

import os
import shutil
import time
from subprocess import Popen, PIPE, STDOUT


def backup_linux_history(target_file_path):
    def list_history_lines():
        cmd = Popen("bash -i -c  'history -r;history' ", shell=True, stdin=PIPE, stdout=PIPE, stderr=STDOUT)
        return [_line.decode("utf-8") for _line in cmd.stdout.readlines()]

    def can_connect(first_list, second_list):
        if not first_list or len(second_list) &lt; len(first_list):
            return False

        for _index, _value in enumerate(first_list):
            if second_list[_index] != _value:
                return False

        return True

    def get_start_connect_line_index(history_line_list, ):
        # total count
        _total_count = 0
        with open(target_file_path, "r", encoding="utf-8") as f:
            for _ in f:
                _total_count += 1

        # start checking line index
        _history_line_count = len(history_line_list)
        if _total_count &lt;= _history_line_count:
            _start_checking_line_index = 0
        else:
            _start_checking_line_index = _total_count - _history_line_count

        # calc
        _line_index = 0
        with open(target_file_path, "r", encoding="utf-8") as f:
            # skip not checking lines
            if _start_checking_line_index &gt; 0:
                for _ in f:
                    _line_index += 1
                    if _line_index &gt;= _start_checking_line_index:
                        break

            _target_checking_lines = [" ".join(_line.lstrip(" ").rstrip("\n").split(" ")[1:]) for _line in f]

        _history_checking_lines = [" ".join(_line.lstrip(" ").rstrip("\n").split(" ")[1:]) for _line in
                                   history_line_list]

        _current_total_index = _line_index
        for _index, _line in enumerate(_target_checking_lines):
            _current_total_index = _index + _line_index
            if can_connect(_target_checking_lines[_index:], _history_checking_lines):
                return _current_total_index

        return _current_total_index

    history_lines = list_history_lines()
    start_connect_line_index = get_start_connect_line_index(history_lines)
    tmp_target_file_path = target_file_path + ".{}.tmp".format(int(time.time()))

    with open(tmp_target_file_path, "w", encoding="utf-8") as fw:
        with open(target_file_path, "r", encoding="utf-8") as fr:
            for line_index, line in enumerate(fr):
                if line_index &gt;= start_connect_line_index:
                    break
                fw.write(line)

        for line in history_lines:
            fw.write(line)

    shutil.move(tmp_target_file_path, target_file_path)


if __name__ == '__main__':
    backup_linux_history(os.path.join(os.path.expanduser("~"), "history.all.log"))

</code></pre>
<h1>
<a id="user-content-2-设置定时任务" class="anchor" href="#2-%E8%AE%BE%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2. 设置定时任务</h1>
<p>通过<code>crontab -e</code>添加任务：</p>
<pre><code>*/15 * * * * python ~/backup_history.py
</code></pre>


    </div>

</div><!-- end container -->
<script src="/static/js/script.js"></script>
</body>
</html>