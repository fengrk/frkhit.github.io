<!doctype html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="utf-8">
    <title>asyncio异步请求示例</title>
    <link rel="stylesheet" href="/static/css/github.css">
    <link rel="stylesheet" href="/static/css/style.css">
    

</head>
<body class="box">

<nav class="nav-menu">
    <ul>
        <li><a href="/">首页</a></li>
        <li><a href="https://github.com/frkhit/frkhit.github.io">源码</a></li>
    </ul>
</nav>

<div class="container">

    <div class="content" role="main">
        
    <h1>
<a id="user-content-asyncio异步请求示例" class="anchor" href="#asyncio%E5%BC%82%E6%AD%A5%E8%AF%B7%E6%B1%82%E7%A4%BA%E4%BE%8B" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>asyncio异步请求示例</h1>
<h1>
<a id="user-content-1-不返回结果" class="anchor" href="#1-%E4%B8%8D%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. 不返回结果</h1>
<p>参考:<a href="https://www.jianshu.com/p/675d2cdf7965" rel="nofollow">Python并发编程</a>
测试代码：</p>
<pre><code>from __future__ import absolute_import

"""
ref: https://www.jianshu.com/p/675d2cdf7965
"""
import asyncio
import time
from concurrent.futures import ThreadPoolExecutor

import aiohttp
import requests

NUMBERS = range(50)
MAX_THREAD_OR_SEMA = 10
URL = 'http://httpbin.org/get?a={}'


def bare_requests():
    def fetch(a):
        r = requests.get(URL.format(a))
        return r.json()['args']['a']

    start = time.time()
    for num in NUMBERS:
        print('fetch({}) = {}'.format(num, fetch(num)))

    print('Use requests cost: {}'.format(time.time() - start))


def threadpool_requests():
    def fetch(a):
        r = requests.get(URL.format(a))
        return r.json()['args']['a']

    start = time.time()
    with ThreadPoolExecutor(max_workers=MAX_THREAD_OR_SEMA) as executor:
        for num, result in zip(NUMBERS, executor.map(fetch, NUMBERS)):
            print('fetch({}) = {}'.format(num, result))

    print('Use requests+ThreadPoolExecutor cost: {}'.format(time.time() - start))


def aiohttp_asyncio():
    async def fetch_async(a):
        async with aiohttp.request('GET', URL.format(a)) as r:
            data = await r.json()
        return data['args']['a']

    start = time.time()
    event_loop = asyncio.get_event_loop()
    tasks = [fetch_async(num) for num in NUMBERS]
    results = event_loop.run_until_complete(asyncio.gather(*tasks))
    for num, result in zip(NUMBERS, results):
        print('fetch({}) = {}'.format(num, result))

    print('Use aiohttp+asyncio cost: {}'.format(time.time() - start))


def aiohttp_asyncio_sema():
    async def fetch_async(a):
        async with aiohttp.request('GET', URL.format(a)) as r:
            data = await r.json()
        return data['args']['a']

    sema = asyncio.Semaphore(MAX_THREAD_OR_SEMA)

    async def print_result(a):
        with (await sema):
            r = await fetch_async(a)
            print('fetch({}) = {}'.format(a, r))

    start = time.time()
    loop = asyncio.get_event_loop()
    f = asyncio.wait([print_result(num) for num in NUMBERS])
    loop.run_until_complete(f)
    print('Use aiohttp+asyncio+semaphore cost: {}'.format(time.time() - start))


if __name__ == '__main__':
    bare_requests()  # 25.6s
    threadpool_requests()  # 2.9s
    aiohttp_asyncio()  # 0.7s
    aiohttp_asyncio_sema()  # 2.5

</code></pre>
<h1>
<a id="user-content-2返回结果" class="anchor" href="#2%E8%BF%94%E5%9B%9E%E7%BB%93%E6%9E%9C" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2.返回结果</h1>
<p>参考:<a href="https://www.jianshu.com/p/675d2cdf7965" rel="nofollow">Python并发编程</a>
代码:</p>
<pre><code>from __future__ import absolute_import

"""
ref: https://www.jianshu.com/p/675d2cdf7965
"""
import asyncio
import time
from concurrent.futures import ThreadPoolExecutor

import aiohttp
import requests

NUMBERS = range(50)
MAX_THREAD_OR_SEMA = 10
URL = 'http://httpbin.org/get?a={}'


def bare_requests():
    def fetch(a):
        r = requests.get(URL.format(a))
        return r.json()['args']['a']

    start = time.time()
    result_list = []
    for num in NUMBERS:
        result_list.append('fetch({}) = {}'.format(num, fetch(num)))

    print("len of result is {}, result list is {}".format(len(result_list), result_list))
    print('Use requests cost: {}'.format(time.time() - start))


def threadpool_requests():
    def fetch(a):
        r = requests.get(URL.format(a))
        return r.json()['args']['a']

    start = time.time()
    result_list = []
    with ThreadPoolExecutor(max_workers=MAX_THREAD_OR_SEMA) as executor:
        for num, result in zip(NUMBERS, executor.map(fetch, NUMBERS)):
            result_list.append('fetch({}) = {}'.format(num, result))

    print("len of result is {}, result list is {}".format(len(result_list), result_list))
    print('Use requests+ThreadPoolExecutor cost: {}'.format(time.time() - start))


def aiohttp_asyncio():
    async def fetch_async(a):
        async with aiohttp.request('GET', URL.format(a)) as r:
            data = await r.json()
        return data['args']['a']

    start = time.time()
    result_list = []
    event_loop = asyncio.get_event_loop()
    tasks = [fetch_async(num) for num in NUMBERS]
    results = event_loop.run_until_complete(asyncio.gather(*tasks))
    for num, result in zip(NUMBERS, results):
        result_list.append('fetch({}) = {}'.format(num, result))

    print("len of result is {}, result list is {}".format(len(result_list), result_list))
    print('Use aiohttp+asyncio cost: {}'.format(time.time() - start))


def aiohttp_asyncio_sema():
    async def fetch_async(a):
        async with aiohttp.request('GET', URL.format(a)) as r:
            data = await r.json()
        return data['args']['a']

    sema = asyncio.Semaphore(MAX_THREAD_OR_SEMA)

    start = time.time()
    result_list = []

    async def print_result(a):
        with (await sema):
            r = await fetch_async(a)
            result_list.append('fetch({}) = {}'.format(a, r))

    loop = asyncio.get_event_loop()
    f = asyncio.wait([print_result(num) for num in NUMBERS])
    loop.run_until_complete(f)

    print("len of result is {}, result list is {}".format(len(result_list), result_list))
    print('Use aiohttp+asyncio+semaphore cost: {}'.format(time.time() - start))


if __name__ == '__main__':
    bare_requests()  # 27.8s
    threadpool_requests()  # 2.5s
    aiohttp_asyncio()  # 0.7s
    aiohttp_asyncio_sema()  # 4.5s

</code></pre>


    </div>

</div><!-- end container -->
<script src="/static/js/script.js"></script>
</body>
</html>