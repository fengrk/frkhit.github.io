<!doctype html>
<html lang="zh-cmn-Hans">
<head>
    <meta charset="utf-8">
    <title>基于sqlite3实现数据缓存</title>
    <link rel="stylesheet" href="/static/css/github.css">
    <link rel="stylesheet" href="/static/css/style.css">
    

</head>
<body class="box">

<nav class="nav-menu">
    <ul>
        <li><a href="/">首页</a></li>
        <li><a href="https://github.com/frkhit/frkhit.github.io">源码</a></li>
    </ul>
</nav>

<div class="container">

    <div class="content" role="main">
        
    <h1>
<a id="user-content-基于sqlite3实现数据缓存" class="anchor" href="#%E5%9F%BA%E4%BA%8Esqlite3%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E7%BC%93%E5%AD%98" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>基于sqlite3实现数据缓存</h1>
<pre><code># -*- coding:utf-8 -*-
import os
import pickle
import sqlite3
import time


class SimpleCache(object):
    def __init__(self):
        self.cache_file = os.path.join("./tmp.dat")

    def get(self, key):
        """

        :rtype: object
        :type key: str
        """
        conn = self._get_connect()

        try:
            value, exp_time = self._get_uid_value(conn, key)
            if exp_time &gt; self._get_current_time():
                return value

        except Exception as e:
            print(e)
        finally:
            conn.close()

        return None

    @staticmethod
    def _get_uid_value(conn, key):
        try:
            sql = "SELECT VALUE, EXPTIME from CACHE where UID = ?"
            cursor = conn.cursor().execute(sql, (key,))
            for row in cursor:
                return pickle.loads(row[0]), row[1]
        except Exception as e:
            print(e)

        return None, None

    def set(self, key, value, ttl=1e10):
        """

        :param ttl: int, living time in second
        :param value: object can pickle
        :param key: str
        """
        conn = self._get_connect()

        try:
            old_value, exp_time = self._get_uid_value(conn, key)
            if old_value is None and exp_time is None:
                sql = "INSERT INTO CACHE(ID, VALUE, EXPTIME, UID) VALUES (NULL, ?, ?, ?)"
            else:
                sql = "UPDATE CACHE SET VALUE = ?, EXPTIME = ? where UID = ?"

            conn.cursor().execute(sql, (pickle.dumps(value), self._get_current_time() + ttl, key))
            conn.commit()
        except Exception as e:
            print(e)
            return None
        finally:
            conn.close()

    def _get_connect(self):
        if not os.path.exists(self.cache_file):
            conn = sqlite3.connect(self.cache_file)
            c = conn.cursor()
            c.execute('''CREATE TABLE CACHE
                   (ID INTEGER PRIMARY KEY AUTOINCREMENT,
                   UID CHAR(32) UNIQUE NOT NULL,
                   EXPTIME INT NOT NULL ,
                   VALUE TEXT);''')
            conn.commit()
            conn.close()

        return sqlite3.connect(self.cache_file)

    @staticmethod
    def _get_current_time():
        """

        :rtype: int
        """
        return time.time()

</code></pre>
<p>使用方法</p>
<pre><code>cache = SimpleCache()

key_id = "key"

print(cache.get(key_id))
cache.set(key_id, "a", 10)
print(cache.get(key_id))

print(cache.get(key_id))
cache.set(key_id, [1, 3, 4], 1)
print(cache.get(key_id))
time.sleep(2)
print(cache.get(key_id))

</code></pre>


    </div>

</div><!-- end container -->
<script src="/static/js/script.js"></script>
</body>
</html>